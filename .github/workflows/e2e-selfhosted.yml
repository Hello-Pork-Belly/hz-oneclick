name: E2E Self-hosted

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode."
        required: false
        default: "preflight"
        type: choice
        options:
          - preflight
          - install
      confirm_install:
        description: "Type the confirmation string to allow install mode."
        required: false
        default: ""
      smoke_strict:
        description: "Treat WARN as failure for smoke gating."
        required: false
        default: false
        type: boolean
      notes:
        description: "Optional run notes (printed to logs)."
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: e2e-selfhosted
  cancel-in-progress: true

jobs:
  e2e_x86:
    runs-on: [self-hosted, linux, x64, hz-e2e-x64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run notes
        run: |
          set -euo pipefail
          echo "notes: ${{ inputs.notes }}"

      - name: Run real-machine E2E
        id: e2e
        env:
          E2E_MODE: ${{ inputs.mode }}
          E2E_CONFIRM_INSTALL: ${{ inputs.confirm_install }}
          E2E_NOTES: ${{ inputs.notes }}
          E2E_LOG_DIR_FILE: ${{ runner.temp }}/e2e_log_dir.txt
          HZ_SMOKE_STRICT: ${{ inputs.smoke_strict && '1' || '0' }}
        run: |
          set -euo pipefail
          log_file="e2e_real_machine.log"
          bash .github/scripts/e2e_real_machine.sh | tee "$log_file"
          echo "log_dir=$(cat "${{ runner.temp }}/e2e_log_dir.txt")" >> "$GITHUB_OUTPUT"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-real-machine-x64-${{ inputs.mode }}
          path: |
            e2e_real_machine.log
            ${{ steps.e2e.outputs.log_dir }}

  e2e_arm:
    runs-on: [self-hosted, linux, arm64, hz-e2e-arm64]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run notes
        run: |
          set -euo pipefail
          echo "notes: ${{ inputs.notes }}"

      - name: Run real-machine E2E
        id: e2e
        env:
          E2E_MODE: ${{ inputs.mode }}
          E2E_CONFIRM_INSTALL: ${{ inputs.confirm_install }}
          E2E_NOTES: ${{ inputs.notes }}
          E2E_LOG_DIR_FILE: ${{ runner.temp }}/e2e_log_dir.txt
          HZ_SMOKE_STRICT: ${{ inputs.smoke_strict && '1' || '0' }}
        run: |
          set -euo pipefail
          log_file="e2e_real_machine.log"
          bash .github/scripts/e2e_real_machine.sh | tee "$log_file"
          echo "log_dir=$(cat "${{ runner.temp }}/e2e_log_dir.txt")" >> "$GITHUB_OUTPUT"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-real-machine-arm64-${{ inputs.mode }}
          path: |
            e2e_real_machine.log
            ${{ steps.e2e.outputs.log_dir }}
