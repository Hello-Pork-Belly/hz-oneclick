name: E2E Self-hosted

on:
  workflow_dispatch:
    inputs:
      smoke_strict:
        description: "Treat WARN as failure for smoke gating (0 or 1)."
        required: false
        default: "0"
      notes:
        description: "Optional run notes (printed to logs)."
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: e2e-selfhosted
  cancel-in-progress: true

jobs:
  e2e_x86:
    runs-on: [self-hosted, linux, x64, hz-e2e]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment info
        run: |
          set -euo pipefail
          uname -a
          bash --version

      - name: Run notes
        run: |
          set -euo pipefail
          echo "notes: ${{ inputs.notes }}"

      - name: Run local CI parity
        env:
          HZ_SMOKE_STRICT: ${{ inputs.smoke_strict }}
        run: |
          set -euo pipefail
          bash .github/scripts/run_ci_locally.sh

  e2e_arm:
    runs-on: [self-hosted, linux, arm64, hz-e2e]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment info
        run: |
          set -euo pipefail
          uname -a
          bash --version

      - name: Run notes
        run: |
          set -euo pipefail
          echo "notes: ${{ inputs.notes }}"

      - name: Run local CI parity
        env:
          HZ_SMOKE_STRICT: ${{ inputs.smoke_strict }}
        run: |
          set -euo pipefail
          bash .github/scripts/run_ci_locally.sh
