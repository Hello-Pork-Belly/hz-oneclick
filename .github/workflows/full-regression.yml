name: Full Regression

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

jobs:
  full-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Smoke test (safe)
        id: smoke
        continue-on-error: true
        env:
          HZ_SMOKE_STRICT: "1"
        run: |
          set +e
          timeout 90s bash tests/smoke.sh
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          set -e
          exit 0

      - name: Upload smoke artifacts
        if: always() && (steps.smoke.outputs.exit_code != '0' || steps.smoke.outputs.HZ_SMOKE_VERDICT == 'WARN' || steps.smoke.outputs.HZ_SMOKE_VERDICT == 'FAIL')
        uses: actions/upload-artifact@v4
        with:
          name: smoke-triage-reports
          path: |
            /tmp/hz-baseline-triage-*.txt
            /tmp/hz-baseline-triage-*.json
          if-no-files-found: ignore

      - name: Enforce smoke verdict
        if: always()
        env:
          HZ_SMOKE_STRICT: "1"
        run: |
          set -euo pipefail
          verdict="${{ steps.smoke.outputs.HZ_SMOKE_VERDICT }}"
          exit_code="${{ steps.smoke.outputs.exit_code }}"
          strict_raw="${HZ_SMOKE_STRICT:-0}"

          normalize_verdict() {
            local value
            value="${1:-}"
            value="${value#"${value%%[![:space:]]*}"}"
            value="${value%"${value##*[![:space:]]}"}"
            printf '%s' "${value^^}"
          }

          smoke_is_truthy() {
            local value
            value="${1:-}"
            value="${value#"${value%%[![:space:]]*}"}"
            value="${value%"${value##*[![:space:]]}"}"
            case "${value,,}" in
              1|true|yes|on)
                return 0
                ;;
              0|false|no|off|"")
                return 1
                ;;
            esac
            return 1
          }

          strict_enabled="false"
          if smoke_is_truthy "$strict_raw"; then
            strict_enabled="true"
          fi

          verdict="$(normalize_verdict "$verdict")"
          exit_code="${exit_code:-0}"
          if [ -z "$verdict" ]; then
            verdict="FAIL"
          fi
          if [ "$exit_code" -ne 0 ]; then
            echo "[smoke-enforce] verdict=${verdict} exit_code=${exit_code} strict=${strict_enabled}"
            exit 1
          fi
          if [ "$verdict" = "FAIL" ]; then
            echo "[smoke-enforce] verdict=FAIL exit_code=${exit_code} strict=${strict_enabled}"
            exit 1
          fi
          if [ "$verdict" = "WARN" ] && [ "$strict_enabled" = "true" ]; then
            echo "[smoke-enforce] verdict=WARN strict=true exit_code=${exit_code}"
            exit 1
          fi

          echo "[smoke-enforce] verdict=${verdict} exit_code=${exit_code} strict=${strict_enabled}"
