name: Regression Checks

on:
  pull_request:
  push:
    branches: [ "main" ]

jobs:
  regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck (reliable)
        id: shellcheck
        shell: bash
        run: |
          set -u
          installed=false

          if command -v shellcheck >/dev/null 2>&1; then
            installed=true
          else
            echo "Trying apt-get install shellcheck..."
            if sudo apt-get -o Acquire::Retries=3 update && sudo apt-get -o Acquire::Retries=3 install -y shellcheck; then
              installed=true
            else
              echo "apt-get failed; trying GitHub release binary..."
              SC_VER="v0.10.0"
              ARCHIVE="shellcheck-${SC_VER}.linux.x86_64.tar.xz"
              URL="https://github.com/koalaman/shellcheck/releases/download/${SC_VER}/${ARCHIVE}"

              tmpdir="$(mktemp -d)"
              if curl -fsSL "$URL" -o "${tmpdir}/${ARCHIVE}" && tar -C "$tmpdir" -xf "${tmpdir}/${ARCHIVE}"; then
                if [ -f "${tmpdir}/shellcheck-${SC_VER}/shellcheck" ]; then
                  sudo install -m 0755 "${tmpdir}/shellcheck-${SC_VER}/shellcheck" /usr/local/bin/shellcheck
                  installed=true
                fi
              fi
              rm -rf "$tmpdir"
            fi
          fi

          echo "installed=${installed}" >> "$GITHUB_OUTPUT"
          if [ "$installed" = "true" ]; then
            shellcheck --version
          else
            echo "ShellCheck unavailable; skipping."
          fi

      - name: Bash syntax check (key scripts)
        run: |
          set -euo pipefail
          bash -n modules/wp/install-ols-wp-standard.sh
          bash -n hz.sh

      - name: ShellCheck (key scripts)
        if: steps.shellcheck.outputs.installed == 'true'
        run: |
          set -euo pipefail
          shellcheck -x modules/wp/install-ols-wp-standard.sh hz.sh

      - name: Forbidden terms in user-facing output
        run: |
          set -euo pipefail
          shopt -s nullglob globstar

          scripts=(
            hz.sh
            modules/**/*.sh
            lib/**/*.sh
          )

          filtered_scripts=()
          for script in "${scripts[@]}"; do
            case "$script" in
              ./tests/*|tests/*|./.github/*|.github/*|./docs/*|docs/*|./.git/*|.git/*)
                continue
                ;;
            esac
            filtered_scripts+=("$script")
          done

          if [ "${#filtered_scripts[@]}" -eq 0 ]; then
            echo "No user-facing shell scripts detected; skipping forbidden term check."
            exit 0
          fi

          forbidden_re='(echo|printf).*?(oracle|aws|amazon|aliyun|tencent|azure|gcp|google cloud)'
          if matches=$(grep -nEi "$forbidden_re" "${filtered_scripts[@]}" || true); then
            if [ -n "$matches" ]; then
              echo "Forbidden cloud provider references found in user-facing scripts:"
              echo "$matches"
              exit 1
            fi
          fi

          echo "No forbidden cloud provider references detected in user-facing scripts."
